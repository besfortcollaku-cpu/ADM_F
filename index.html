<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Adventure Maze – Admin</title>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e6eefc; }
    .app { display:flex; min-height:100vh; }
    .sidebar { width:240px; background:#0f1a33; padding:16px; box-sizing:border-box; border-right:1px solid #1f2a44; }
    .brand { font-weight:800; letter-spacing:.5px; margin-bottom:14px; }
    .btn { width:100%; padding:10px 12px; margin:6px 0; border:1px solid #223056; background:#101c36; color:#e6eefc; border-radius:10px; cursor:pointer; text-align:left; }
    .btn.active { background:#17305f; border-color:#2a57b8; }
    .main { flex:1; padding:18px; box-sizing:border-box; }
    pre { white-space:pre-wrap; word-break:break-word; background:#0b1220; border:1px solid #223056; padding:12px; border-radius:10px; }
    .muted { color:#9bb0d0; font-size:12px; }

    /* === UI v2 === */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:0 0 12px 0}
    .btn2{padding:8px 10px;border-radius:10px;border:1px solid #223056;background:#101c36;color:#e6eefc;cursor:pointer}
    .btn2:hover{background:#14224a}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px;margin:12px 0}
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(1,minmax(220px,1fr))} }
    .card{background:#0f1a33;border:1px solid #1f2a44;border-radius:14px;padding:14px}
    .kpi-title{font-size:12px;color:#9bb0d0;margin-bottom:6px}
    .kpi-value{font-size:28px;font-weight:800}
    .kpi-sub{margin-top:6px;font-size:12px;color:#9bb0d0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 10px 0}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid #223056;background:#101c36;color:#e6eefc;cursor:pointer}
    .tab.active{background:#17305f;border-color:#2a57b8}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1f2a44;font-size:14px}
    .table tr:hover{background:#0b1833}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .right{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    input, select { padding:10px; border-radius:10px; border:1px solid #223056; background:#0b1220; color:#e6eefc; outline:none; }
    .split{display:grid;grid-template-columns: 1.1fr .9fr; gap:12px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }
    .danger { color:#ffb4b4; }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #223056;
      background:#101c36;
      font-size:12px;
      color:#e6eefc;
    }
    tr.selected { background:#14224a !important; }
  </style>
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="brand">
      Adventure Maze<br/>
      <span class="muted">Admin Panel</span>
    </div>

    <button class="btn active" id="nav-home">Admin</button>

    <div style="margin-top:12px" class="muted">
      Tip: secret is saved in sessionStorage (this tab only).
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="toolbar">
      <div class="tabs">
        <button class="tab active" id="tab-dashboard">Dashboard</button>
        <button class="tab" id="tab-users">Users</button>
        <button class="tab" id="tab-online">Online</button>
      </div>

      <div class="right" style="margin-left:auto">
        <span class="muted">Status:</span>
        <span id="statusText" class="pill">Idle</span>
        <button class="btn2" id="btn-refresh">Refresh</button>
        <button class="btn2" id="btn-secret">Change secret</button>
      </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <section id="view-dashboard">
      <h2 style="margin:8px 0 0 0">Dashboard</h2>

      <div class="grid">
        <div class="card">
          <div class="kpi-title">Total Users</div>
          <div class="kpi-value" id="kpiUsers">–</div>
          <div class="kpi-sub">Registered users in DB</div>
        </div>
        <div class="card">
          <div class="kpi-title">Total Coins</div>
          <div class="kpi-value" id="kpiCoins">–</div>
          <div class="kpi-sub">Sum of user coins</div>
        </div>
        <div class="card">
          <div class="kpi-title">Online Now</div>
          <div class="kpi-value" id="kpiOnline">–</div>
          <div class="kpi-sub">Seen in last N minutes</div>
        </div>

        <div class="card">
          <div class="kpi-title">Ad +50 Claims</div>
          <div class="kpi-value" id="kpiAdCount">–</div>
          <div class="kpi-sub">Count of reward_claims type=ad_50</div>
        </div>
        <div class="card">
          <div class="kpi-title">Daily Logins</div>
          <div class="kpi-value" id="kpiDailyCount">–</div>
          <div class="kpi-sub">Count of daily_login claims</div>
        </div>
        <div class="card">
          <div class="kpi-title">Levels Completed</div>
          <div class="kpi-value" id="kpiLevels">–</div>
          <div class="kpi-sub">Rows in level_rewards</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0">Raw</h3>
        <div id="dashboard">Loading…</div>
      </div>
    </section>

    <!-- USERS VIEW -->
    <section id="view-users" class="hidden">
      <h2 style="margin:8px 0 0 0">Users</h2>

      <div class="toolbar">
        <input id="usersSearch" placeholder="Search username or uid…" style="min-width:260px"/>
        <select id="usersOrder">
          <option value="updated_at_desc">Order: Updated</option>
          <option value="coins_desc">Order: Coins</option>
          <option value="created_at_desc">Order: Created</option>
        </select>
        <button class="btn2" id="btn-users-search">Search</button>

        <div class="right" style="margin-left:auto">
          <button class="btn2" id="btn-users-prev">Prev</button>
          <button class="btn2" id="btn-users-next">Next</button>
          <span class="muted" id="usersMeta">–</span>
        </div>
      </div>

      <div class="split">
        <div class="card">
          <h3 style="margin:0 0 10px 0">List</h3>
          <div style="overflow:auto">
            <table class="table" id="usersTable">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>UID</th>
                  <th>Coins</th>
                  <th>Skips</th>
                  <th>Hints</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody id="usersTbody">
                <tr><td colspan="6" class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 10px 0">User Detail</h3>
          <div id="userDetail" class="muted">Click a user row to load details.</div>
        </div>
      </div>
    </section>

    <!-- ONLINE VIEW -->
    <section id="view-online" class="hidden">
      <h2 style="margin:8px 0 0 0">Online</h2>

      <div class="toolbar">
        <span class="muted">Minutes window:</span>
        <input id="onlineMinutes" type="number" min="1" value="5" style="width:90px"/>
        <button class="btn2" id="btn-online-refresh">Refresh</button>

        <div class="right" style="margin-left:auto">
          <span class="muted" id="onlineMeta">–</span>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px 0">Sessions</h3>
        <div style="overflow:auto">
          <table class="table" id="onlineTable">
            <thead>
              <tr>
                <th>Username</th>
                <th>UID</th>
                <th>Coins</th>
                <th>Last Seen</th>
                <th>Started</th>
                <th>User Agent</th>
              </tr>
            </thead>
            <tbody id="onlineTbody">
              <tr><td colspan="6" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
const API_BASE = "https://adventuremaze.onrender.com";
let ADMIN_SECRET = sessionStorage.getItem("ADMIN_SECRET");

let usersOffset = 0;
const usersLimit = 25;
let lastUsersCount = 0;
let selectedUid = null;

function setStatus(txt) {
  const el = document.getElementById("statusText");
  if (el) el.textContent = txt;
}

function requireSecret(force=false) {
  if (force) {
    sessionStorage.removeItem("ADMIN_SECRET");
    ADMIN_SECRET = null;
  }
  if (!ADMIN_SECRET) {
    ADMIN_SECRET = prompt("Enter admin secret:");
    if (!ADMIN_SECRET) {
      alert("Admin secret required");
      throw new Error("No admin secret");
    }
    sessionStorage.setItem("ADMIN_SECRET", ADMIN_SECRET);
  }
}

async function adminFetch(path, retryOn401=true) {
  requireSecret();

  const res = await fetch(API_BASE + path, {
    method: "GET",
    headers: { "x-admin-secret": ADMIN_SECRET }
  });

  const txt = await res.text().catch(()=> "");

  // if secret wrong, prompt once automatically then retry
  if (res.status === 401 && retryOn401) {
    try {
      requireSecret(true);
      return await adminFetch(path, false);
    } catch {}
  }

  if (!res.ok) throw new Error("Admin request failed: " + res.status + " " + txt);
  try { return JSON.parse(txt); } catch { return { ok:true, raw: txt }; }
}

function showView(which) {
  document.querySelectorAll("section[id^='view-']").forEach(s => s.classList.add("hidden"));
  const view = document.getElementById("view-" + which);
  if (view) view.classList.remove("hidden");

  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  const tab = document.getElementById("tab-" + which);
  if (tab) tab.classList.add("active");
}

/* -----------------------
   DASHBOARD
----------------------- */
async function loadDashboard() {
  try {
    setStatus("Loading dashboard…");
    const out = await adminFetch("/admin/stats");

    const d = out?.data || {};
    document.getElementById("kpiUsers").textContent = d.users_total ?? "–";
    document.getElementById("kpiCoins").textContent = d.coins_total ?? "–";
    document.getElementById("kpiOnline").textContent = d.online_now ?? "–";
    document.getElementById("kpiAdCount").textContent = d.ad50_count ?? "–";
    document.getElementById("kpiDailyCount").textContent = d.daily_login_count ?? "–";
    document.getElementById("kpiLevels").textContent = d.level_complete_count ?? "–";

    document.getElementById("dashboard").innerHTML =
      "<pre class='mono'>" + escapeHtml(JSON.stringify(out, null, 2)) + "</pre>";

    setStatus("OK");
  } catch (e) {
    console.error(e);
    document.getElementById("dashboard").innerHTML =
      "<span class='danger'>Error: " + escapeHtml(e?.message || String(e)) + "</span>";
    setStatus("Error");
  }
}

/* -----------------------
   USERS
----------------------- */
function userRowHTML(u) {
  const updated = (u.updated_at || "").toString().replace("T"," ").replace("Z","");
  const uid = String(u.uid || "");
  const isSel = selectedUid && selectedUid === uid;
  return `
    <tr data-uid="${escapeHtml(uid)}" class="${isSel ? "selected" : ""}">
      <td>${escapeHtml(u.username || "")}</td>
      <td class="mono">${escapeHtml(uid)}</td>
      <td>${num(u.coins)}</td>
      <td>${num(u.free_skips_used)}</td>
      <td>${num(u.free_hints_used)}</td>
      <td class="muted">${escapeHtml(updated)}</td>
    </tr>
  `;
}

function setUsersMeta(count) {
  const meta = document.getElementById("usersMeta");
  if (!meta) return;

  if (!count) {
    meta.textContent = "0 users";
    return;
  }

  const start = Math.min(count, usersOffset + 1);
  const end = Math.min(count, usersOffset + usersLimit);
  meta.textContent = `Showing ${start}–${end} of ${count}`;
}

async function loadUsers(reset=false) {
  try {
    setStatus("Loading users…");
    if (reset) usersOffset = 0;

    const q = document.getElementById("usersSearch").value.trim();
    const order = document.getElementById("usersOrder").value;

    const url = "/admin/users"
      + "?search=" + encodeURIComponent(q)
      + "&limit=" + encodeURIComponent(usersLimit)
      + "&offset=" + encodeURIComponent(usersOffset)
      + "&order=" + encodeURIComponent(order);

    const out = await adminFetch(url);
    const rows = out?.rows || [];
    const count = Number(out?.count ?? 0);
    lastUsersCount = count;

    // if offset too far, step back to last page and refetch
    if (count > 0 && usersOffset >= count) {
      usersOffset = Math.max(0, Math.floor((count - 1) / usersLimit) * usersLimit);
      return loadUsers(false);
    }

    const tbody = document.getElementById("usersTbody");
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted">No users found.</td></tr>`;
    } else {
      tbody.innerHTML = rows.map(userRowHTML).join("");
    }

    setUsersMeta(count);

    // row click -> load details
    tbody.querySelectorAll("tr[data-uid]").forEach(tr => {
      tr.addEventListener("click", async () => {
        tbody.querySelectorAll("tr").forEach(x => x.classList.remove("selected"));
        tr.classList.add("selected");

        const uid = tr.getAttribute("data-uid");
        if (!uid) return;

        selectedUid = uid;
        await loadUserDetail(uid);
      });
    });

    setStatus("OK");
  } catch (e) {
    console.error(e);
    document.getElementById("usersTbody").innerHTML =
      `<tr><td colspan="6" class="danger">Error: ${escapeHtml(e?.message || String(e))}</td></tr>`;
    setUsersMeta(0);
    setStatus("Error");
  }
}

async function loadUserDetail(uid) {
  try {
    setStatus("Loading user…");
    const out = await adminFetch("/admin/users/" + encodeURIComponent(uid));
    const d = out?.data || out;

    document.getElementById("userDetail").innerHTML =
      "<pre class='mono'>" + escapeHtml(JSON.stringify(d, null, 2)) + "</pre>";

    setStatus("OK");
  } catch (e) {
    console.error(e);
    document.getElementById("userDetail").innerHTML =
      `<span class="danger">Error: ${escapeHtml(e?.message || String(e))}</span>`;
    setStatus("Error");
  }
}

/* -----------------------
   ONLINE
----------------------- */
function onlineRowHTML(r) {
  const lastSeen = (r.last_seen_at || "").toString().replace("T"," ").replace("Z","");
  const started = (r.started_at || "").toString().replace("T"," ").replace("Z","");
  return `
    <tr>
      <td>${escapeHtml(r.username || "")}</td>
      <td class="mono">${escapeHtml(r.uid || "")}</td>
      <td>${num(r.coins)}</td>
      <td class="muted">${escapeHtml(lastSeen)}</td>
      <td class="muted">${escapeHtml(started)}</td>
      <td class="muted">${escapeHtml((r.user_agent || "").slice(0,120))}</td>
    </tr>
  `;
}

async function loadOnline() {
  try {
    setStatus("Loading online…");
    const minutes = Math.max(1, Number(document.getElementById("onlineMinutes").value || 5));
    const out = await adminFetch("/admin/online?minutes=" + encodeURIComponent(minutes) + "&limit=50&offset=0");
    const rows = out?.rows || [];
    const count = Number(out?.count ?? rows.length);

    const tbody = document.getElementById("onlineTbody");
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted">No online users in last ${minutes} minutes.</td></tr>`;
    } else {
      tbody.innerHTML = rows.map(onlineRowHTML).join("");
    }

    document.getElementById("onlineMeta").textContent = `${count} online (window ${minutes}m)`;
    setStatus("OK");
  } catch (e) {
    console.error(e);
    document.getElementById("onlineTbody").innerHTML =
      `<tr><td colspan="6" class="danger">Error: ${escapeHtml(e?.message || String(e))}</td></tr>`;
    document.getElementById("onlineMeta").textContent = "–";
    setStatus("Error");
  }
}

/* -----------------------
   HELPERS
----------------------- */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function num(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

/* -----------------------
   NAV / INIT
----------------------- */
document.getElementById("tab-dashboard").onclick = () => { showView("dashboard"); loadDashboard(); };
document.getElementById("tab-users").onclick = () => { showView("users"); loadUsers(true); };
document.getElementById("tab-online").onclick = () => { showView("online"); loadOnline(); };

document.getElementById("btn-refresh").onclick = () => {
  const active = document.querySelector(".tab.active")?.id || "tab-dashboard";
  if (active === "tab-users") loadUsers(false);
  else if (active === "tab-online") loadOnline();
  else loadDashboard();
};

document.getElementById("btn-secret").onclick = () => {
  try {
    requireSecret(true);
    document.getElementById("btn-refresh").click();
  } catch {}
};

document.getElementById("btn-users-search").onclick = () => loadUsers(true);
document.getElementById("btn-users-prev").onclick = () => {
  usersOffset = Math.max(0, usersOffset - usersLimit);
  loadUsers(false);
};
document.getElementById("btn-users-next").onclick = () => {
  if (lastUsersCount > 0 && usersOffset + usersLimit >= lastUsersCount) return;
  usersOffset = usersOffset + usersLimit;
  loadUsers(false);
};

document.getElementById("usersSearch").addEventListener("keydown", (e) => {
  if (e.key === "Enter") loadUsers(true);
});

document.getElementById("btn-online-refresh").onclick = () => loadOnline();

// load dashboard on open
window.onload = () => {
  showView("dashboard");
  loadDashboard();
};
</script>

</body>
</html>