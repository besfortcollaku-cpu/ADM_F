<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Adventure Maze – Admin</title>

<style>
/* ===== BASE ===== */
body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#e6eefc}
.app{display:flex;min-height:100vh}
.hidden{display:none}
.muted{color:#9bb0d0;font-size:12px}
.mono{font-family:ui-monospace,monospace}
.danger{color:#ffb4b4}

/* ===== SIDEBAR ===== */
.sidebar{
  width:220px;background:#0f1a33;padding:14px;
  border-right:1px solid #1f2a44
}
.brand{font-weight:800;margin-bottom:12px}
.btn{
  width:100%;padding:10px;margin:6px 0;
  background:#101c36;border:1px solid #223056;
  color:#e6eefc;border-radius:10px;text-align:left
}
.btn.active{background:#17305f;border-color:#2a57b8}

/* ===== MAIN ===== */
.main{flex:1;padding:16px}

/* ===== TOP BAR ===== */
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tabs{display:flex;gap:6px;flex-wrap:wrap}
.tab{
  padding:8px 10px;border-radius:10px;
  background:#101c36;border:1px solid #223056;color:#e6eefc
}
.tab.active{background:#17305f;border-color:#2a57b8}
.pill{
  padding:6px 10px;border-radius:999px;
  border:1px solid #223056;background:#101c36;font-size:12px
}

/* ===== DASHBOARD ===== */
.grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0
}
.card{
  background:#0f1a33;border:1px solid #1f2a44;
  border-radius:14px;padding:14px
}
.kpi-title{font-size:12px;color:#9bb0d0}
.kpi-value{font-size:28px;font-weight:800}

/* ===== TABLES ===== */
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1f2a44;font-size:14px}
tr:hover{background:#14224a}

/* ===== MOBILE ===== */
@media(max-width:800px){
  .app{flex-direction:column}
  .sidebar{width:100%;border-right:none;border-bottom:1px solid #1f2a44}
  .grid{grid-template-columns:1fr}
  th,td{font-size:13px}
}
</style>
</head>

<body>
<div class="app">

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="brand">Adventure Maze<br><span class="muted">Admin Panel</span></div>
  <button class="btn active">Admin</button>
  <div class="muted">Secret saved per tab</div>
</div>

<!-- MAIN -->
<div class="main">

<!-- TOP -->
<div class="toolbar">
  <div class="tabs">
    <button class="tab active" id="tab-dashboard">Dashboard</button>
    <button class="tab" id="tab-users">Users</button>
    <button class="tab" id="tab-online">Online</button>
  </div>
  <span class="pill" id="statusText">Idle</span>
</div>

<!-- DASHBOARD -->
<section id="view-dashboard">
  <div class="grid">
    <div class="card"><div class="kpi-title">Users</div><div id="kpiUsers" class="kpi-value">–</div></div>
    <div class="card"><div class="kpi-title">Coins</div><div id="kpiCoins" class="kpi-value">–</div></div>
    <div class="card"><div class="kpi-title">Online</div><div id="kpiOnline" class="kpi-value">–</div></div>
  </div>
  <pre id="dashboard" class="mono">Loading…</pre>
</section>

<!-- USERS -->
<section id="view-users" class="hidden">
  <div class="card table-wrap">
    <table>
      <thead>
        <tr><th>Username</th><th>UID</th><th>Coins</th></tr>
      </thead>
      <tbody id="usersTbody">
        <tr><td colspan="3" class="muted">Load users</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- ONLINE -->
<section id="view-online" class="hidden">
  <div class="muted" style="margin-bottom:8px">
    Shows users with active sessions (game must call session/start + ping)
  </div>
  <div class="card table-wrap">
    <table>
      <thead>
        <tr><th>User</th><th>UID</th><th>Last Seen</th></tr>
      </thead>
      <tbody id="onlineTbody">
        <tr><td colspan="3" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</section>

</div>
</div>

<script>
const API="https://adventuremaze.onrender.com";
let SECRET=sessionStorage.getItem("ADMIN_SECRET");

function needSecret(){
  if(!SECRET){
    SECRET=prompt("Admin secret:");
    sessionStorage.setItem("ADMIN_SECRET",SECRET);
  }
}

async function af(path){
  needSecret();
  const r=await fetch(API+path,{headers:{"x-admin-secret":SECRET}});
  return r.json();
}

function show(v){
  ["dashboard","users","online"].forEach(x=>{
    document.getElementById("view-"+x).classList.toggle("hidden",x!==v);
    document.getElementById("tab-"+x).classList.toggle("active",x===v);
  });
}

async function loadDash(){
  const d=await af("/admin/stats");
  document.getElementById("kpiUsers").textContent=d.data.users_total;
  document.getElementById("kpiCoins").textContent=d.data.coins_total;
  document.getElementById("kpiOnline").textContent=d.data.online_now;
  document.getElementById("dashboard").textContent=JSON.stringify(d,null,2);
}

async function loadOnline(){
  const d=await af("/admin/online?minutes=5");
  document.getElementById("onlineTbody").innerHTML=
    d.rows.length
    ? d.rows.map(r=>`<tr><td>${r.username}</td><td>${r.uid}</td><td>${r.last_seen_at}</td></tr>`).join("")
    : `<tr><td colspan="3" class="muted">No active sessions</td></tr>`;
}

document.getElementById("tab-dashboard").onclick=()=>{show("dashboard");loadDash();}
document.getElementById("tab-online").onclick=()=>{show("online");loadOnline();}
document.getElementById("tab-users").onclick=()=>show("users");

setInterval(()=>{
  if(document.getElementById("tab-online").classList.contains("active")){
    loadOnline();
  }
},15000);

loadDash();
</script>

</body>
</html>